// Datasource configuration
datasource db {
  provider = "postgresql"

}

// Prisma Client generator
generator client {
  provider = "prisma-client-js"
}

// ============== USER & WORKSPACE ==============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?   // Hashed password for credentials auth
  image         String?   // Avatar URL
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  workspaces    WorkspaceMember[]
  tasks         Task[]
  updates       TaskUpdate[]
}

// Description: Workspace = Team/Organization container
// Contains projects, members, and all related work
model Workspace {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique  // URL-friendly name (e.g., "acme-corp")
  description   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  members       WorkspaceMember[]
  projects      Project[]
}

// Description: WorkspaceMember = User's role in a workspace
// Links users to workspaces with specific permissions (owner/manager/developer)
model WorkspaceMember {
  id            String    @id @default(cuid())
  userId        String
  workspaceId   String
  role          Role      @default(DEVELOPER)  // Access level
  createdAt     DateTime  @default(now())

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])  // User can only be member once per workspace
}

enum Role {
  OWNER      // Full control
  MANAGER    // Manage team & projects
  DEVELOPER  // View & update tasks
}

// ============== PROJECTS & EPICS ==============

// Description: Project = Collection of work towards a goal
// Contains tasks organized into epics and sprints
model Project {
  id            String    @id @default(cuid())
  workspaceId   String
  name          String
  description   String?
  goal          String?   // AI will break this down into tasks
  status        ProjectStatus @default(ACTIVE)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  epics         Epic[]
  tasks         Task[]
  sprints       Sprint[]
}

enum ProjectStatus {
  ACTIVE     // Currently being worked on
  PAUSED     // On hold
  COMPLETED  // Finished
  ARCHIVED   // No longer relevant
}

// Description: Epic = Large body of work (feature area)
// Groups related tasks together
// Example: "User Authentication System" epic contains 5+ tasks
model Epic {
  id            String    @id @default(cuid())
  projectId     String
  title         String
  description   String?
  status        EpicStatus @default(BACKLOG)
  createdAt     DateTime  @default(now())

  // Relations
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  features      Feature[]
  tasks         Task[]
}

enum EpicStatus {
  BACKLOG     // Not started
  IN_PROGRESS // Being worked on
  COMPLETED   // Finished
}

// Description: Feature = Medium-sized functionality (optional)
// Groups related user stories together
// Example: "Login Feature" contains multiple user stories
model Feature {
  id            String    @id @default(cuid())
  epicId        String
  title         String
  description   String?
  status        FeatureStatus @default(BACKLOG)
  createdAt     DateTime  @default(now())

  // Relations
  epic          Epic      @relation(fields: [epicId], references: [id], onDelete: Cascade)
  userStories   UserStory[]
  tasks         Task[]
}

enum FeatureStatus {
  BACKLOG     // Not started
  IN_PROGRESS // Being worked on
  COMPLETED   // Finished
}

// Description: UserStory = User-focused requirement (optional)
// Describes functionality from user perspective
// Example: "As a user, I want to reset my password"
model UserStory {
  id            String    @id @default(cuid())
  featureId     String
  title         String
  description   String?
  acceptanceCriteria String?
  status        UserStoryStatus @default(BACKLOG)
  createdAt     DateTime  @default(now())

  // Relations
  feature       Feature   @relation(fields: [featureId], references: [id], onDelete: Cascade)
  tasks         Task[]
}

enum UserStoryStatus {
  BACKLOG     // Not started
  IN_PROGRESS // Being worked on
  COMPLETED   // Finished
}


// ============== TASKS ==============

// Description: Task = Individual unit of work
// Smallest trackable item, assigned to developers
// Can be tracked, updated, and marked as done
model Task {
  id              String    @id @default(cuid())
  projectId       String
  epicId          String?   // Which epic does this belong to
  featureId       String?   // Optional: Which feature does this belong to
  userStoryId     String?   // Optional: Which user story does this belong to
  sprintId        String?   // Which sprint is this in (for sprints)
  title           String
  description     String?
  status          TaskStatus @default(TODO)
  priority        Priority   @default(MEDIUM)
  estimatedHours  Int?      // AI estimates this
  actualHours     Int?      // Developer logs time
  assigneeId      String?   // Who's working on this
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  epic            Epic?     @relation(fields: [epicId], references: [id], onDelete: SetNull)
  feature         Feature?  @relation(fields: [featureId], references: [id], onDelete: SetNull)
  userStory       UserStory? @relation(fields: [userStoryId], references: [id], onDelete: SetNull)
  sprint          Sprint?   @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  assignee        User?     @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  updates         TaskUpdate[]
  risks           Risk[]
}

enum TaskStatus {
  TODO        // Not started
  IN_PROGRESS // Being worked on
  IN_REVIEW   // Waiting for approval
  BLOCKED     // Can't proceed (has a blocker)
  COMPLETED   // Done
}

enum Priority {
  LOW       // Can wait
  MEDIUM    // Normal
  HIGH      // Important
  CRITICAL  // Urgent, blocks everything
}

// Description: TaskUpdate = History of task changes
// Records status changes, comments, and timeline
// Helps create daily summaries and track progress
model TaskUpdate {
  id        String    @id @default(cuid())
  taskId    String
  userId    String
  oldStatus TaskStatus?
  newStatus TaskStatus?
  comment   String?   // What changed + why
  createdAt DateTime  @default(now())

  // Relations
  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============== SPRINTS ==============

// Description: Sprint = Time-boxed work period
// Typically 1-2 weeks, contains selected tasks
// Used for agile workflow
model Sprint {
  id        String    @id @default(cuid())
  projectId String
  name      String    // "Sprint 1", "Sprint 2", etc.
  startDate DateTime
  endDate   DateTime
  status    SprintStatus @default(PLANNED)
  goal      String?   // What does team want to accomplish
  createdAt DateTime  @default(now())

  // Relations
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks     Task[]
}

enum SprintStatus {
  PLANNED    // Not started yet
  ACTIVE     // Currently running
  COMPLETED  // Finished
}

// ============== RISK MANAGEMENT ==============

// Description: Risk = Potential problem detected by AI
// AI analyzes tasks and creates risks automatically
// Example: "Task incomplete for 5 days = blocker risk"
model Risk {
  id          String    @id @default(cuid())
  taskId      String
  type        RiskType
  description String    // What's the risk
  severity    Severity  @default(MEDIUM)
  resolved    Boolean   @default(false)
  detectedAt  DateTime  @default(now())

  // Relations
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

enum RiskType {
  BLOCKER              // Task is stuck
  RESOURCE_CONSTRAINT  // Not enough people/time
  TIMELINE_RISK        // Will miss deadline
  DEPENDENCY_ISSUE     // Waiting on other task
  TECHNICAL_DEBT       // Code quality issue
}

enum Severity {
  LOW       // Can ignore
  MEDIUM    // Should monitor
  HIGH      // Take action
  CRITICAL  // Stop everything
}

// ============== GITHUB INTEGRATION ==============

// Description: GitHubIntegration = Connection to GitHub repo
// Allows auto-closing tasks from PRs/commits
// Example: PR "Fix #task_123" auto-closes task when merged
model GitHubIntegration {
  id            String    @id @default(cuid())
  workspaceId   String
  repoOwner     String    // Repository owner username
  repoName      String    // Repository name
  accessToken   String    // GitHub personal access token
  webhookSecret String    // Secret for verifying webhooks
  createdAt     DateTime  @default(now())
}